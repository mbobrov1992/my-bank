# Приложение «Мой Банк» (My Bank)

Микросервисное банковское приложение на Java 21 с использованием Spring Boot и Spring Cloud.  
Поддерживает функционал управления аккаунтами, пополнения/снятия средств, переводов между счетами и уведомлений.

## Структура проекта

Приложение состоит из следующих микросервисов:
- **front** — фронтенд с веб-интерфейсом, реализованным с помощью Spring Web MVC и Thymeleaf. Взаимодействует с микросервисами через Gateway API.
- **accounts** — микросервис для управления аккаунтами и счетами пользователей.
- **cash** — микросервис для внесения и снятия средств со счетов.
- **transfer** — микросервис для перевода средств между счетами пользователей.
- **notifications** — микросервис отправки уведомлений (логирование).
- **api-gateway** — шлюз на Spring Cloud Gateway для маршрутизации запросов и проброса JWT.

А также компонентов инфраструктуры:
- **keycloak** — сервер авторизации OAuth 2.0 для аутентификации пользователей и межсервисной авторизации.
- **consul** — сервис регистрации микросервисов и управления конфигурацией.
- **postgres** — база данных.

## Требования

- Java 21
- PostgreSQL 17+
- Docker и Docker Compose
- Maven 3.6+
- Keycloak 26.4+
- HashiCorp Consul 1.22+

## Конфигурация

### PostgreSQL
Используется один экземпляр PostgreSQL с базой данных `my_bank`. Для микросервисов разделены схемы согласно паттерну Database per Service.  
Параметры подключения задаются через переменные окружения:

- `DB_USERNAME` — имя пользователя PostgreSQL
- `DB_PASSWORD` — пароль пользователя PostgreSQL

### Keycloak
Сервер авторизации OAuth 2.0, настроенный на Authorization Code Flow для фронтенда и Client Credentials Flow для микросервисов.  
Переменные окружения для Keycloak администратора и клиентов:

- `KEYCLOAK_ADMIN` — пользователь-админ Keycloak
- `KEYCLOAK_ADMIN_PASSWORD` — пароль администратора Keycloak

Для каждого микросервиса свои пары:  
`*_CLIENT_ID` и `*_CLIENT_SECRET`

#### Проблема с редиректом на Keycloak в Docker-сети
`my-bank-front` перенаправляет пользователя на хост http://keycloak:8080 для выполнения аутентификации.  
Браузер пользователя не может разрешить доменное имя keycloak через стандартный DNS, поскольку это внутреннее имя сервера.  
В результате запрос на редирект завершается ошибкой "хост не найден", и процесс аутентификации прерывается.  
Необходимо добавить в файл `/etc/hosts` (на машине пользователя) следующую запись:
```
127.0.0.1 keycloak
```
Это принудительно сопоставит имя keycloak с локальным loopback-адресом, позволяя браузеру обращаться к Keycloak-серверу  
на той же машине, как будто это полноценный домен.


### Consul
Используется в качестве Service Discovery и внешнего хранилища конфигураций.

## Сборка и управление проектом

В рамках мультипроекта все микросервисы собираются с помощью Maven, каждый сервис — подмодуль.

### Сборка JAR файлов

```bash
make package
```

В директориях микросервисов появятся исполняемые JAR-файлы.

### Запуск JAR вручную

java -jar my-bank-front/target/my-bank-front.jar --server.port=8080


### Сборка через Docker

```bash
make build
```

### Сборка и развертывание через Docker Compose

Перед запуском определите необходимые переменные окружения в `.env` файле или в консоли.

```bash
make deploy
```